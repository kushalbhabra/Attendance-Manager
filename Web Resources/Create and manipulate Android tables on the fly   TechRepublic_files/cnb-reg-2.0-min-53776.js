CNB.Registration=new Class({Implements:[Options,Events],options:{appId:'187',urlPrefix:'/members/',defaultUserName:'',defaultAvatarUrl:''},initialize:function(options){this.setOptions(options);this.regEvents={'login':{'action':this.login.bind(this),'overlayOptions':{'containerClass':'contain-overlay-12','url':this.options.urlPrefix+'login'}},'logout':{'action':this.logout.bind(this),'url':this.options.urlPrefix+'logout'},'confirm':{'action':this.confirmAccount.bind(this),'overlayOptions':{'containerClass':'contain-overlay-12','url':this.options.urlPrefix+'confirm'}},'join':{'action':this.join.bind(this),'overlayOptions':{'containerClass':'contain-overlay-12','url':this.options.urlPrefix+'join'}},'forgot':{'action':this.forgotPassword.bind(this),'overlayOptions':{'containerClass':'contain-overlay-12','url':this.options.urlPrefix+'forgetpw'}},'manage':{'action':this.manage.bind(this),'overlayOptions':{'containerClass':'contain-overlay-12','url':this.options.urlPrefix+'manage'}}};this.overlay=new CNB.Overlay.Async({id:'reg-overlay',containerClass:''});this.overlay.addEvent('contentReady',this.initForms.bind(this));this.addEvent('loginSuccess',this.overlay.close.bind(this.overlay));window.addEvent('domready',function(){$(document.body).addEvents({'click:relay(a[regaction])':this.handleRegEvent.bind(this)});this.initGating(document.body)}.bind(this))},handleRegEvent:function(e,el){e.stop();var regSrc=el.getProperty('regsource');var regAction=el.getProperty('regaction');if(typeof this.regEvents[regAction]!='undefined'){this.regEvents[regAction].action({'data':{'regSrc':regSrc}})}},initForms:function(content){content.getElements('form').each(function(form){this.validate=new CNB.Validator(form,{onValidateSuccess:this.handleFormSubmit.bind(this)})}.bind(this))},initRegEvents:function(){},initGating:function(contentContainer){$(contentContainer).getElements('.reg-gated').each(function(el){var eventType='click';var nextAction=$empty;switch(el.get('tag')){case'a':eventType='click';nextAction=function(){window.location=el.get('href')};break;case'form':eventType='submit';nextAction=function(){el.submit()};break}var regSrc=el.getProperty('regsource');var loginPrompt='';el.addEvent(eventType,this.gatedEvent.bindWithEvent(this,[nextAction,regSrc,loginPrompt]));el.removeClass('reg-gated')}.bind(this))},gatedEvent:function(e,nextAction,regSrc,loginPrompt){if($chk(e))e=new Event(e).stop();if(CNB.User.get('isLoggedIn')){nextAction()}else{if(location.hostname.contains('findarticles')||location.hostname.contains('bnetau')){this.addOneEvent('loginSuccess',function(){nextAction.delay(2000)})}else{this.addOneEvent('loginSuccess',nextAction)}this.login({'regSrc':regSrc},null,true)}},login:function(options,e,disableDefaultSuccess){if($chk(e))e=new Event(e).stop();if(!$chk(options))options={};if(!$chk(disableDefaultSuccess)){this.addOneEvent('loginSuccess',function(){this.overlay.notify('Hello '+CNB.User.get('userName')+'. You are now logged in.')}.bind(this))}options=$merge(this.regEvents.login.overlayOptions,this.formatOptionsData(options));CNB.log('login',options);this.overlay.open(options)},join:function(options,e){if($chk(e))e=new Event(e).stop();this.overlay.addOneEvent('contentReady',function(content){var input=content.getElement('input[name=username]');input.addEvent('blur',this.checkUsername.bind(this,input))}.bind(this));options=$merge(this.regEvents.join.overlayOptions,this.formatOptionsData(options));this.overlay.open(options)},forgotPassword:function(options,e){if($chk(e))e=new Event(e).stop();options=$merge(this.regEvents.forgot.overlayOptions,this.formatOptionsData(options));this.overlay.open(options)},confirmAccount:function(){this.overlay.open(this.regEvents.confirm.overlayOptions)},manage:function(options,e){if($chk(e))e=new Event(e).stop();this.checkLoggedIn(null,function(){this.overlay.addOneEvent('contentReady',function(content){var selector=new CNB.Selector(content.getElements('.select-1 li'),content.getElements('.select-box')).load();var inputEmail=content.getElement('input[name=email]');var inputUsername=content.getElement('input[name=username]');CNB.User.extend({'email':inputEmail.get('value'),'userName':inputUsername.get('value')});inputUsername.addEvent('blur',function(){if(CNB.User.get('userName')!=inputUsername.get('value')){this.checkUsername(inputUsername)}}.bind(this))}.bind(this));var options=$merge(this.regEvents.manage.overlayOptions,this.formatOptionsData(options));this.overlay.open(options)}.bind(this))},checkLoggedIn:function(e,nextAction){if($chk(e))e=new Event(e).stop();var request=new Request.JSON({url:this.options.urlPrefix+'checkLoggedIn',onSuccess:function(data){if(!data){return false}if(data.isLoggedIn=='true'||data.isLoggedIn===true){nextAction()}else{this.addOneEvent('loginSuccess',nextAction);this.login(null,null,true)}}.bind(this),onFailure:function(xhr){CNB.log('Request Failed: '.xhr)},noCache:true}).post()},checkUsername:function(input){var username=input.get('value');if(!$chk(username))return false;var request=new Request.JSON({url:this.options.urlPrefix+'checkUsername',data:{'username':username},onSuccess:function(data){if(data.status=='success'&&data.isUsernameTaken=='true'){try{input.getParent('form').retrieve('validator').addError(input,'Sorry, that Username is taken')}catch(e){CNB.log('error: username check - ',e)}}}.bind(this),onFailure:function(xhr){CNB.log('Request Failed: '.xhr)},noCache:true}).get()},logout:function(options,e){if($chk(e))e=new Event(e).stop();var request=new Request.JSON({url:this.regEvents.logout.url,data:{'logout':'true'},onSuccess:this.handleResponse.bind(this),onFailure:function(xhr){CNB.log('Request Failed: '.xhr)}}).get()},updateDisplay:function(){var loggedInConts=$$('.reg-is-logged-in');var loggedOutConts=$$('.reg-is-logged-out');var userNameConts=$$('.reg-update-username');var avatarConts=$$('.reg-update-avatar');var avatarUrl=(CNB.User.get('isLoggedIn')===true)?CNB.User.get('avatarUrl'):this.options.defaultAvatarUrl;var userName=(CNB.User.get('isLoggedIn')===true)?CNB.User.get('userName'):this.options.defaultUserName;loggedInConts.each(function(el){if(CNB.User.get('isLoggedIn')===true){el.removeClass('hide')}else{el.addClass('hide')}}.bind(this));loggedOutConts.each(function(el){if(CNB.User.get('isLoggedIn')===true){el.addClass('hide')}else{el.removeClass('hide')}}.bind(this));userNameConts.each(function(el){el.set('html',userName)});avatarConts.each(function(el){if(el.getProperty('src')){el.setProperty('src',avatarUrl)}})},handleFormSubmit:function(event,form){event.stop();this.overlay.loader.add();this.activeForm=form;var url=form.getProperty('action');var data=$merge(form.toJSON(),{'appId':this.options.appId});var request=new Request.JSON({url:url,data:data,onSuccess:this.handleResponse.bind(this),onFailure:function(xhr){CNB.log('Request Failed: '.xhr)},noCache:true}).post()},handleResponse:function(data){this.overlay.loader.remove();if(!data){return false}if(data.status=='failure'){this.displayFormErrors(data.errors);return false}switch(data.action){case'login':CNB.User.set('isLoggedIn',true);if(typeof data.ssoIframe!='undefined'){this.loadSsoIframe(data.ssoIframe)}this.setUserData(data);this.updateDisplay();this.fireEvent('loginSuccess',data);DW.redir({ctype:'ria;evt;objtyp;obj',cval:'shrtreg;success;act;login'});break;case'join':CNB.User.set('isLoggedIn',true);if(typeof data.ssoIframe!='undefined'){this.loadSsoIframe(data.ssoIframe)}this.setUserData(data);this.confirmAccount();this.updateDisplay();this.fireEvent('joinSuccess',data);DW.redir({ctype:'ria;evt;objtyp;obj',cval:'shrtreg;success;act;join',usrAction:25});break;case'logout':CNB.User.set('isLoggedIn',false);if(typeof data.ssoIframe!='undefined'){this.loadSsoIframe(data.ssoIframe)}this.setUserData({});this.updateDisplay();this.fireEvent('logoutSuccess');this.overlay.notify('You are now logged out.');DW.redir({ctype:'ria;evt;objtyp;obj',cval:'shrtreg;success;act;logout'});break;case'manage':if(CNB.User.get('email')!=data.email){this.confirmAccount()}else{this.overlay.notify('Your account has been updated.')}this.setUserData(data);this.updateDisplay();DW.redir({ctype:'ria;evt;objtyp;obj',cval:'shrtreg;success;act;update',usrAction:12});break;case'forgotPassword':this.overlay.notify('Password update instructions have been sent to your email.');DW.redir({ctype:'ria;evt;objtyp;obj',cval:'shrtreg;success;act;forgotpw'});break;case'changePassword':this.overlay.notify('Your password has been changed.');DW.redir({ctype:'ria;evt;objtyp;obj',cval:'shrtreg;success;act;changepw'});break}},setUserData:function(data){if(!data){return false}var userData={userName:'',regId:'',email:'',permToken:'',sessToken:'',rememberMe:'',avatarUrl:''};$each(userData,function(val,key){if(typeof data[key]!='undefined'){userData[key]=data[key]}});CNB.User.extend(userData)},formatOptionsData:function(options){options=options||{};var data={};if(typeof options.regSrc!='undefined'){data.regSrc=options.regSrc;delete options.regSrc}if(typeof options.appId!='undefined'){data.appId=options.appId;delete options.appId}else{data.appId=this.options.appId}return $merge({'data':data},options)},displayFormErrors:function(errors){$splat(errors).each(function(error){var msg='';switch(error){case'emailAddress (CODE: EMAIL_IN_USE)':msg='That Email Address is already in use.';break;case'emailAddress (CODE: INVALIDEMAILFORMAT)':msg='Invalid Email format.';break;case'password (CODE: TOOSHORT)':msg='Password must be at least 8 characters.';break;case'Bad request. The supplied email address is invalid.':msg='There is no record of that Email Address';break;case'Error changing the password!':msg='There was a problem. Please make sure your password is at least 8 characters.';break;case'password (CODE: PSWD_CNFM_NOMATCH)':msg='The Password and Confirm Password fields do not match.';break;default:msg=error}this.validate.addGlobalError(msg)}.bind(this))},loadSsoIframe:function(html){var div=new Element('div',{'id':'reg-sso-iframe'}).inject($(document.body),'bottom');div.set('html',html)}});